<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Results - Exam Prep</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <header>
    <div class="container">
      <a href="index.html" class="logo">Exam Prep</a>
      <nav>
        <a href="index.html">Home</a>
        <a href="practice.html">Practice</a>
        <a href="exam.html">Mock Exam</a>
        <a href="admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main id="main">
    <div class="container">
      <div class="card" id="results-summary">
        <div class="results-summary">
          <div class="score-circle" id="score-circle">
            <span class="score-value" id="score-value">--%</span>
            <span class="score-label">Score</span>
          </div>
          <h2 class="result-status" id="result-status">--</h2>
          <p class="text-muted" id="result-detail">-- of -- questions correct</p>
          <div class="result-details">
            <span id="time-taken">Time: --:--</span>
            <span id="passing-score">Passing: 70%</span>
          </div>
          <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <a href="exam.html" class="btn btn-primary">Retake Exam</a>
            <a href="practice.html" class="btn btn-secondary">Practice Mode</a>
            <a href="index.html" class="btn btn-secondary">Home</a>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="mb-2">Review Questions</h3>

        <div class="review-filters" id="review-filters">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="incorrect">Incorrect</button>
          <button class="filter-btn" data-filter="flagged">Flagged</button>
        </div>

        <div id="review-container">
          <p class="text-muted">No results to display.</p>
        </div>
      </div>
    </div>
  </main>

  <script src="js/app.js"></script>
  <script src="js/progress.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // Load exam data for reference
      await App.loadExamData();

      // Get exam result from sessionStorage or localStorage
      let result = sessionStorage.getItem('lastExamResult');
      if (result) {
        result = JSON.parse(result);
      } else {
        result = Progress.getLastExamResult(App.currentExamId);
      }

      if (!result) {
        document.getElementById('results-summary').innerHTML = `
          <div class="results-summary">
            <h2>No Results Found</h2>
            <p class="text-muted mb-3">Take an exam to see your results here.</p>
            <a href="exam.html" class="btn btn-primary">Start Mock Exam</a>
          </div>
        `;
        document.getElementById('review-filters').classList.add('hidden');
        return;
      }

      // Display summary
      const scoreCircle = document.getElementById('score-circle');
      const isPassing = result.score >= 70;
      scoreCircle.classList.add(isPassing ? 'pass' : 'fail');
      document.getElementById('score-value').textContent = result.score + '%';
      document.getElementById('result-status').textContent = isPassing ? 'PASSED' : 'FAILED';
      document.getElementById('result-status').classList.add(isPassing ? 'pass' : 'fail');
      document.getElementById('result-detail').textContent = `${result.correct} of ${result.total} questions correct`;
      document.getElementById('time-taken').textContent = `Time: ${App.formatTime(result.timeUsed)}`;

      // Render review questions
      const container = document.getElementById('review-container');
      let currentFilter = 'all';

      function renderReview() {
        const answers = result.answers || [];
        const filtered = answers.filter(a => {
          if (currentFilter === 'incorrect') return !a.isCorrect;
          if (currentFilter === 'flagged') return a.flagged;
          return true;
        });

        if (filtered.length === 0) {
          container.innerHTML = `<p class="text-muted">No questions match this filter.</p>`;
          return;
        }

        container.innerHTML = filtered.map((a, i) => {
          const q = a.question;
          const selectedText = a.selectedAnswer !== null ? q.options[a.selectedAnswer] : 'Not answered';
          const correctText = q.options[q.correct];
          const sourceLink = q.source?.url
            ? `<a href="${q.source.url}" target="_blank" rel="noopener">${q.source.name}</a>`
            : q.source?.name || 'General knowledge';

          return `
            <div class="review-question ${a.isCorrect ? 'correct' : 'incorrect'}">
              <div class="review-question-header">
                <span class="question-number">Question ${answers.indexOf(a) + 1}</span>
                <span class="review-status ${a.isCorrect ? 'correct' : 'incorrect'}">
                  ${a.isCorrect ? 'Correct' : 'Incorrect'}
                </span>
              </div>
              <p class="question-text" style="font-size: 1rem; margin-bottom: 0.75rem;">${q.question}</p>
              <p style="margin-bottom: 0.5rem;">
                <strong>Your answer:</strong> ${a.selectedAnswer !== null ? LETTERS[a.selectedAnswer] + '. ' : ''}${selectedText}
              </p>
              ${!a.isCorrect ? `
                <p style="margin-bottom: 0.5rem; color: var(--success);">
                  <strong>Correct answer:</strong> ${LETTERS[q.correct]}. ${correctText}
                </p>
              ` : ''}
              <p class="text-muted" style="font-size: 0.875rem; margin-bottom: 0.5rem;">${q.explanation}</p>
              <p class="feedback-source" style="font-size: 0.875rem;">Source: ${sourceLink}</p>
            </div>
          `;
        }).join('');
      }

      renderReview();

      // Filter buttons
      document.getElementById('review-filters').addEventListener('click', (e) => {
        const btn = e.target.closest('.filter-btn');
        if (!btn) return;

        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        renderReview();
      });
    });
  </script>
</body>
</html>
